<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="井上 研一"><meta name=twitter:card content="summary"><meta name=twitter:title content="画像認識の基礎（tf.keras.applications）"><meta name=twitter:description content="TensorFlow / Kerasを使用した画像認識（分類タスク）のファインチューニングについて。 tf.keras.applcationsに含まれるアルゴリズム"><meta property="og:title" content="画像認識の基礎（tf.keras.applications）"><meta property="og:description" content="TensorFlow / Kerasを使用した画像認識（分類タスク）のファインチューニングについて。 tf.keras.applcationsに含まれるアルゴリズム"><meta property="og:type" content="article"><meta property="og:url" content="https://inoccu.com/docs/datascience/image-classification-keras.html"><meta property="article:section" content="docs"><meta property="article:published_time" content="2021-05-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-14T00:00:00+00:00"><meta property="og:site_name" content="井上 研一"><base href=https://inoccu.com/docs/datascience/image-classification-keras.html><title>画像認識の基礎（tf.keras.applications） - 井上 研一</title><link rel=canonical href=https://inoccu.com/docs/datascience/image-classification-keras.html><link href="https://fonts.googleapis.com/css?family=Lato:400,700|Noto+Sans+JP:400,700" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://inoccu.com/css/coder.min.58559d500751d2f6759c868b878b980d04b2e36c95648b776eee7e3368465abd.css integrity="sha256-WFWdUAdR0vZ1nIaLh4uYDQSy42yVZIt3bu5+M2hGWr0=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://inoccu.com/css/custom.css><link rel=icon type=image/png href=https://inoccu.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://inoccu.com/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.83.1"></head><body class=colorscheme-light><div id=back_to_top><a href=#></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://inoccu.com/>Inoue, Ken'ichi</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://inoccu.com/profile/>プロフィール</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/profile/writing.html>執筆</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/profile/speaking.html>登壇</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/posts/>投稿</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/docs/>資料</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/search/>検索</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/contact/>お問い合わせ</a></li></ul></section></nav><div class=content><section class="container page"><article><header><h1>画像認識の基礎（tf.keras.applications）</h1></header><p>TensorFlow / Kerasを使用した画像認識（分類タスク）のファインチューニングについて。</p><h2 id=tfkerasapplcationsに含まれるアルゴリズム>tf.keras.applcationsに含まれるアルゴリズム</h2><ul><li>ResNet<ul><li>2015年に登場、100層以上のネットワークを構成し精度を向上させた</li><li><a href=https://arxiv.org/abs/1512.03385>https://arxiv.org/abs/1512.03385</a></li><li>デフォルトの入力サイズは224x224</li><li>ResNet50（50層）、ResNet101（101層）、ResNet152（152層）</li></ul></li><li>DenseNet<ul><li>2017年に登場、ResNetを踏まえて開発された</li><li>デフォルトの入力サイズは224x224</li><li>DenseNet121（121層）、DenseNet169（169層）、DenseNet201（201層）</li></ul></li><li>efficientetnet</li><li>inception_resnet_v2<ul><li>2017年に登場</li><li><a href=https://arxiv.org/abs/1602.07261>https://arxiv.org/abs/1602.07261</a></li><li>デフォルトの入力サイズは299x299</li></ul></li><li>inception_v3</li><li>mobilenet</li><li>mobilenet_v2</li><li>mobilenet_v3</li><li>nasnet</li><li>resnet_v2</li><li>vgg16</li><li>vgg19</li><li>xception</li></ul><h3 id=比較keras-documentationによる>比較（Keras Documentationによる）</h3><p>精度評価はImageNetによる。<br>Top-1 Accuracyは、最上位の予測結果が正答である精度。<br>Top-5 Accuraryは、上位5個の予測結果に正答が含まれる精度。</p><table><thead><tr><th>Model</th><th>Size</th><th>Top-1 Accuracy</th><th>Top-5 Accuracy</th><th>Parameters</th><th>Depth</th></tr></thead><tbody><tr><td>Xception</td><td>88 MB</td><td>0.790</td><td>0.945</td><td>22,910,480</td><td>126</td></tr><tr><td>VGG16</td><td>528 MB</td><td>0.715</td><td>0.901</td><td>138,357,544</td><td>23</td></tr><tr><td>VGG19</td><td>549 MB</td><td>0.727</td><td>0.910</td><td>143,667,240</td><td>26</td></tr><tr><td>ResNet50</td><td>99 MB</td><td>0.759</td><td>0.929</td><td>25,636,712</td><td>168</td></tr><tr><td>InceptionV3</td><td>92 MB</td><td>0.788</td><td>0.944</td><td>23,851,784</td><td>159</td></tr><tr><td>InceptionResNetV2</td><td>215 MB</td><td>0.804</td><td>0.953</td><td>55,873,736</td><td>572</td></tr><tr><td>MobileNet</td><td>17 MB</td><td>0.665</td><td>0.871</td><td>4,253,864</td><td>88</td></tr><tr><td>DenseNet121</td><td>33 MB</td><td>0.745</td><td>0.918</td><td>8,062,504</td><td>121</td></tr><tr><td>DenseNet169</td><td>57 MB</td><td>0.759</td><td>0.928</td><td>14,307,880</td><td>169</td></tr><tr><td>DenseNet201</td><td>80 MB</td><td>0.770</td><td>0.933</td><td>20,242,984</td><td>201</td></tr></tbody></table><h3 id=kerasにおける引数>Kerasにおける引数</h3><p>各アルゴリズムで共通に用いられる引数（抜粋）</p><ul><li>weights: None or &lsquo;imagenet&rsquo; imagenetを使用した初期の学習を行うか否か。Noneの場合は各ニューロンのウエイトの初期値はランダム。</li><li>include_top: 出力層側にある全結合層を含むかどうか。</li><li>classes: 出力層のニューロン数（分類したいクラス数）。include_topがTrueでweightsがNoneの場合しか指定できない。</li><li>input_shape: 入力する画像の形状。</li></ul><h3 id=コード例>コード例</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> tensorflow <span style=color:#f92672>as</span> tf

base_model <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>applications<span style=color:#f92672>.</span>MobileNetV2(weights<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;imagenet&#39;</span>, include_top<span style=color:#f92672>=</span>False)
x <span style=color:#f92672>=</span> base_model<span style=color:#f92672>.</span>output
x <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>layers<span style=color:#f92672>.</span>GlobalAveragePooling2D()(x)
x <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>layers<span style=color:#f92672>.</span>Dense(<span style=color:#ae81ff>512</span>, activation<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;relu&#39;</span>)(x)
x <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>layers<span style=color:#f92672>.</span>Dense(<span style=color:#ae81ff>256</span>, activation<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;relu&#39;</span>)(x)
preds <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>layers<span style=color:#f92672>.</span>Dense(<span style=color:#ae81ff>3</span>, activation<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;softmax&#39;</span>)(x)

model <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>Model(inputs<span style=color:#f92672>=</span>base_model<span style=color:#f92672>.</span>input, outputs<span style=color:#f92672>=</span>preds)

<span style=color:#75715e># ベースモデル部分は再学習しない（Non-trainable params）</span>
<span style=color:#66d9ef>for</span> layer <span style=color:#f92672>in</span> base_model<span style=color:#f92672>.</span>layers:
    layer<span style=color:#f92672>.</span>trainable<span style=color:#f92672>=</span>False

model<span style=color:#f92672>.</span>compile(optimizer<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Adam&#39;</span>, loss<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;categorical_crossentropy&#39;</span>, metrics<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;accuracy&#39;</span>])
model<span style=color:#f92672>.</span>summary()
</code></pre></div><p>作成されたネットワークはこのようになる。（長いので途中は省略）<br>include_topがFalseのため、dense (Dense)以下の3層は上記コード内で追加したもの。</p><pre><code>__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_1 (InputLayer)            [(None, None, None,  0                                            
__________________________________________________________________________________________________
Conv1 (Conv2D)                  (None, None, None, 3 864         input_1[0][0]                    
__________________________________________________________________________________________________
bn_Conv1 (BatchNormalization)   (None, None, None, 3 128         Conv1[0][0]                      
__________________________________________________________________________________________________
Conv1_relu (ReLU)               (None, None, None, 3 0           bn_Conv1[0][0]                   
__________________________________________________________________________________________________
expanded_conv_depthwise (Depthw (None, None, None, 3 288         Conv1_relu[0][0]                 
__________________________________________________________________________________________________
（中略）
__________________________________________________________________________________________________
dense (Dense)                   (None, 512)          655872      global_average_pooling2d[0][0]   
__________________________________________________________________________________________________
dense_1 (Dense)                 (None, 256)          131328      dense[0][0]                      
__________________________________________________________________________________________________
dense_2 (Dense)                 (None, 3)            771         dense_1[0][0]                    
==================================================================================================
Total params: 3,045,955
Trainable params: 787,971
Non-trainable params: 2,257,984
__________________________________________________________________________________________________
</code></pre><p>続きのコード。これでモデルのトレーニングが行われる。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>train_datagen <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>preprocessing<span style=color:#f92672>.</span>image<span style=color:#f92672>.</span>ImageDataGenerator(
    preprocessing_function <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>applications<span style=color:#f92672>.</span>mobilenet_v2<span style=color:#f92672>.</span>preprocess_input)

train_generator <span style=color:#f92672>=</span> train_datagen<span style=color:#f92672>.</span>flow_from_directory(<span style=color:#e6db74>&#39;train&#39;</span>,
                                                 color_mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;rgb&#39;</span>,
                                                 batch_size<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>,
                                                 class_mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;categorical&#39;</span>,
                                                 shuffle<span style=color:#f92672>=</span>True)

log_file <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>fit_generator(generator<span style=color:#f92672>=</span>train_generator,
                   steps_per_epoch<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>,
                   epochs<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>)
</code></pre></div><p>トレーニングの過程を可視化する。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>plt<span style=color:#f92672>.</span>plot(log_file<span style=color:#f92672>.</span>history[<span style=color:#e6db74>&#39;accuracy&#39;</span>], <span style=color:#e6db74>&#39;-bo&#39;</span>, label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_accuracy&#34;</span>)
plt<span style=color:#f92672>.</span>plot(log_file<span style=color:#f92672>.</span>history[<span style=color:#e6db74>&#39;loss&#39;</span>], <span style=color:#e6db74>&#39;-r*&#39;</span>, label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_loss&#34;</span>)
plt<span style=color:#f92672>.</span>title(<span style=color:#e6db74>&#39;Training Loss and Accuracy&#39;</span>)
plt<span style=color:#f92672>.</span>ylabel(<span style=color:#e6db74>&#39;Loss/Accuracy&#39;</span>)
plt<span style=color:#f92672>.</span>xlabel(<span style=color:#e6db74>&#39;Epoch #&#39;</span>)
plt<span style=color:#f92672>.</span>legend(loc<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;center right&#39;</span>)
plt<span style=color:#f92672>.</span>show()
</code></pre></div><h2 id=参考文献>参考文献</h2><ul><li><a href=https://keras.io/ja/applications/>https://keras.io/ja/applications/</a></li><li><a href=https://deepsquare.jp/2020/04/resnet-densenet/>https://deepsquare.jp/2020/04/resnet-densenet/</a></li></ul></article></section></div><footer class=footer><section class=container>©
2020 -
2021
Inoue, Ken'ichi</section></footer><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js id=MathJax-script></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}}</script><script src=https://code.jquery.com/jquery-3.5.0.min.js integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/typed.js@2.0.11></script><script src=https://inoccu.com/js/main.js></script></main><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-2794204-22','auto'),ga('send','pageview'))</script></body></html>