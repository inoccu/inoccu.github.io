<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="井上 研一"><meta name=twitter:card content="summary"><meta name=twitter:title content="「使ってわかったAWSのAI」コードリスト"><meta name=twitter:description content="書籍「使ってわかったAWSのAI」（井上研一＝著、リックテレコム＝刊）のコードリストです。 出版社によるサポートサイト Amazon.co.jp"><meta property="og:title" content="「使ってわかったAWSのAI」コードリスト"><meta property="og:description" content="書籍「使ってわかったAWSのAI」（井上研一＝著、リックテレコム＝刊）のコードリストです。 出版社によるサポートサイト Amazon.co.jp"><meta property="og:type" content="article"><meta property="og:url" content="https://inoccu.com/docs/awsai/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-05-26T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-26T00:00:00+00:00"><meta property="og:site_name" content="井上 研一"><base href=https://inoccu.com/docs/awsai/><title>「使ってわかったAWSのAI」コードリスト - 井上 研一</title><link rel=canonical href=https://inoccu.com/docs/awsai/><link href="https://fonts.googleapis.com/css?family=Lato:400,700|Noto+Sans+JP:400,700" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://inoccu.com/css/coder.min.76681fdb0711c555514e38148a33b692f685093870cba0a00547d255d7518258.css integrity="sha256-dmgf2wcRxVVRTjgUijO2kvaFCThwy6CgBUfSVddRglg=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://inoccu.com/css/custom.css><link rel=icon type=image/png href=https://inoccu.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://inoccu.com/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.83.1"></head><body class=colorscheme-light><div id=back_to_top><a href=#></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://inoccu.com/>Inoue, Ken'ichi</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://inoccu.com/profile/>プロフィール</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/profile/writing.html>執筆</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/profile/speaking.html>登壇</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/posts/>投稿</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/docs/>資料</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/search/>検索</a></li><li class=navigation-item><a class=navigation-link href=https://inoccu.com/contact/>お問い合わせ</a></li></ul></section></nav><div class=content><section class="container page"><article><header><h1>「使ってわかったAWSのAI」コードリスト</h1></header><p>書籍「使ってわかったAWSのAI」（井上研一＝著、リックテレコム＝刊）のコードリストです。<br><a href=http://www.ric.co.jp/book/contents/book_1246.html>出版社によるサポートサイト</a><br><a href=https://amzn.to/2WhXCcw>Amazon.co.jpで購入</a></p><h2 id=第3章-aiサービス>第3章 AIサービス</h2><h3 id=325-認証情報の保存>3.2.5 認証情報の保存</h3><pre><code>[default]
aws_access_key_id = ＜アクセスキーID＞
aws_secret_access_key = ＜シークレットアクセスキー＞
</code></pre><h3 id=327-jupyter-notebookでaws-sdk-for-pythonを使う>3.2.7 Jupyter NotebookでAWS SDK for Pythonを使う</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#960050;background-color:#1e0010>!</span>pip install <span style=color:#f92672>--</span>upgrade boto3
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;s3&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ap-northeast-1&#39;</span>)
client<span style=color:#f92672>.</span>list_buckets()
</code></pre></div><h3 id=332-画像を用いたモノの検出>3.3.2 画像を用いたモノの検出</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;rekognition&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ap-northeast-1&#39;</span>)

<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;dog.jpg&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> image_file:
    bytes_data <span style=color:#f92672>=</span> image_file<span style=color:#f92672>.</span>read()
    response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>detect_labels(Image<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;Bytes&#39;</span>: bytes_data})
    
    <span style=color:#66d9ef>print</span>(json<span style=color:#f92672>.</span>dumps(response, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</code></pre></div><h3 id=333-画像を用いた顔の検出>3.3.3 画像を用いた顔の検出</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;rekognition&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ap-northeast-1&#39;</span>)

<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;persons.jpg&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> image_file:
    bytes_data <span style=color:#f92672>=</span> image_file<span style=color:#f92672>.</span>read()
    response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>detect_faces(Image<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;Bytes&#39;</span>: bytes_data}, Attributes<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;ALL&#39;</span>])

    <span style=color:#66d9ef>print</span>(json<span style=color:#f92672>.</span>dumps(response, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</code></pre></div><h3 id=342-自然言語を識別する>3.4.2 自然言語を識別する</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;comprehend&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;us-east-1&#39;</span>)

text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;貴社の記者が汽車で帰社した&#39;</span>

response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>detect_dominant_language(Text<span style=color:#f92672>=</span>text)
<span style=color:#66d9ef>print</span>(json<span style=color:#f92672>.</span>dumps(response, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</code></pre></div><h3 id=343-エンティティを抽出する>3.4.3 エンティティを抽出する</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;comprehend&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;us-east-1&#39;</span>)
text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Amazon Comprehend は、機械学習を使用してテキスト内でインサイトや関係性を検出する自然言語処理 (NLP) サービスです。機械学習の経験は必要ありません。</span><span style=color:#ae81ff>\
</span><span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span><span style=color:#e6db74>構造化されていないデータには膨大な量の潜在的な宝物があります。お客様の E メール、サポートチケット、製品レビュー、ソーシャルメディア、広告コピーが、ビジネスの役に立つ顧客感情のインサイトを表します。問題はそれをどのようにして手に入れるかです。 このように、機械学習は、膨大な数のテキスト内の特定の関心項目 (アナリストレポートで会社名を見つけるなど) を正確に特定することに特に優れており、言語の中に隠された感情 (マイナスのレビューやカスタマーサービスエージェントと顧客の積極的なのやりとりの特定) をほぼ無限の規模で学習することができます。’</span>

response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>detect_entities(Text<span style=color:#f92672>=</span>text, LanguageCode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ja&#39;</span>)
<span style=color:#66d9ef>print</span>(json<span style=color:#f92672>.</span>dumps(response, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, ensure_ascii<span style=color:#f92672>=</span>False))
</code></pre></div><h3 id=352-英語の書類画像からデータを取得する>3.5.2 英語の書類画像からデータを取得する</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;textract&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;us-east-1&#39;</span>)

response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>analyze_document(
    Document<span style=color:#f92672>=</span>{
        <span style=color:#e6db74>&#39;S3Object&#39;</span>: {
            <span style=color:#e6db74>&#39;Bucket&#39;</span>: <span style=color:#e6db74>&#39;＜格納先のS3バケット名＞&#39;</span>,
            <span style=color:#e6db74>&#39;Name&#39;</span>: <span style=color:#e6db74>&#39;＜格納先のS3オブジェクト名＞&#39;</span>,
            <span style=color:#75715e>#&#39;Version&#39;: &#39;＜S3でバージョン管理を行っている場合は、バージョン値＞&#39;</span>
	    }
    },
    FeatureTypes<span style=color:#f92672>=</span>[<span style=color:#960050;background-color:#1e0010>＜フォームを認識させる場合は</span>FORMS<span style=color:#960050;background-color:#1e0010>、テーブルを認識させる場合は</span>TABLES<span style=color:#960050;background-color:#1e0010>＞</span>]
)

<span style=color:#66d9ef>print</span>(json<span style=color:#f92672>.</span>dumps(response, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</code></pre></div><h3 id=362-カスタム用語を使わない翻訳>3.6.2 カスタム用語を使わない翻訳</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;translate&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;us-east-1&#39;</span>)

text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Sukiyaki is a song by Japanese crooner Kyu Sakamoto, first released in Japan in 1961. The song topped the charts in several countries, including on the Billboard Hot 100 in 1963. The song has grown to become one of the world</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>s best-selling singles of all time, having sold over 13 million copies worldwide.&#39;</span>

response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>translate_text(
    Text<span style=color:#f92672>=</span>text,
    SourceLanguageCode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;en&#39;</span>,
    TargetLanguageCode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ja&#39;</span>
)

<span style=color:#66d9ef>print</span>(json<span style=color:#f92672>.</span>dumps(response, ensure_ascii<span style=color:#f92672>=</span>False, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</code></pre></div><h3 id=363-カスタム用語を使った翻訳>3.6.3 カスタム用語を使った翻訳</h3><pre><code>en,ja
Sukiyaki,上を向いて歩こう
</code></pre><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;translate&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;us-east-1&#39;</span>)

<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;my_terminology.csv&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> mt:
    bytes_data <span style=color:#f92672>=</span> mt<span style=color:#f92672>.</span>read()
    response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>import_terminology(
        Name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;my_terminology&#39;</span>,
        MergeStrategy<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;OVERWRITE&#39;</span>,
        TerminologyData<span style=color:#f92672>=</span>{
            <span style=color:#e6db74>&#39;File&#39;</span>: bytes_data,
            <span style=color:#e6db74>&#39;Format&#39;</span>: <span style=color:#e6db74>&#39;CSV&#39;</span>
	    }
    )
    
    <span style=color:#66d9ef>print</span>(response)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>print</span>(client<span style=color:#f92672>.</span>list_terminologies())
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Sukiyaki is a song by Japanese crooner Kyu Sakamoto, first released in Japan in 1961. The song topped the charts in several countries, including on the Billboard Hot 100 in 1963. The song has grown to become one of the world</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>s best-selling singles of all time, having sold over 13 million copies worldwide.&#39;</span>

response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>translate_text(
    Text<span style=color:#f92672>=</span>text,
    TerminologyNames<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;my_terminology&#39;</span>],
    SourceLanguageCode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;en&#39;</span>,
    TargetLanguageCode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ja&#39;</span>
)

<span style=color:#66d9ef>print</span>(json<span style=color:#f92672>.</span>dumps(response, ensure_ascii<span style=color:#f92672>=</span>False, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</code></pre></div><h3 id=372-日本語の音声ファイルを認識>3.7.2 日本語の音声ファイルを認識</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;transcribe&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ap-northeast-1&#39;</span>)

response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>start_transcription_job(
    TranscriptionJobName<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜ジョブ名＞&#39;</span>,
    LanguageCode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ja-JP&#39;</span>,
    MediaFormat<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜mp3 / mp4 / wav / flacのいずれか＞&#39;</span>,
    Media<span style=color:#f92672>=</span>{
	    <span style=color:#e6db74>&#39;MediaFileUri&#39;</span>: <span style=color:#e6db74>&#39;＜音声ファイルのオブジェクトURL＞&#39;</span>
    }
)

<span style=color:#66d9ef>print</span>(response)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>get_transcription_job(
	TranscriptionJobName<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜ジョブ名＞&#39;</span>
)
<span style=color:#66d9ef>print</span>(response)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> urllib.request

r <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>urlopen(response[<span style=color:#e6db74>&#39;TranscriptionJob&#39;</span>][<span style=color:#e6db74>&#39;Transcript&#39;</span>][<span style=color:#e6db74>&#39;TranscriptFileUri&#39;</span>])
json_data <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(r<span style=color:#f92672>.</span>read())
<span style=color:#66d9ef>print</span>(json<span style=color:#f92672>.</span>dumps(json_data, indent<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, ensure_ascii<span style=color:#f92672>=</span>False))
</code></pre></div><h3 id=382-日本語テキストを音声に変換>3.8.2 日本語テキストを音声に変換</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;polly&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ap-northeast-1&#39;</span>)

text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;こんにちは。私はAmazon Pollyのミズキです。&#39;</span>
response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>start_speech_synthesis_task(
    OutputFormat<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜mp3 / ogg_vorbis / pcmのいずれか＞&#39;</span>,
    OutputS3BucketName<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜格納先のS3バケット名＞&#39;</span>,
    Text<span style=color:#f92672>=</span>text,
    VoiceId<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Mizuki&#39;</span>
)

<span style=color:#66d9ef>print</span>(response)
</code></pre></div><h3 id=398-チャットボットの公開>3.9.8 チャットボットの公開</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> json

client <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;lex-runtime&#39;</span>, region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;us-east-1&#39;</span>)

text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;book a car&#39;</span>

response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>post_text(
    botName<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;BookTrip&#39;</span>,
    botAlias<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Dev&#39;</span>,
    userId<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;user01&#39;</span>,
    inputText<span style=color:#f92672>=</span>text
)

<span style=color:#66d9ef>print</span>(response)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;New York&#39;</span>

response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>post_text(
    botName<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;BookTrip&#39;</span>,
    botAlias<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Dev&#39;</span>,
    userId<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;user01&#39;</span>,
    inputText<span style=color:#f92672>=</span>text
)

<span style=color:#66d9ef>print</span>(response)
</code></pre></div><h3 id=3113-amazon-personalizeへのデータのインポートデータセットグループの作成>3.11.3 Amazon Personalizeへのデータのインポート（データセットグループの作成）</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
    <span style=color:#f92672>&#34;Id&#34;</span>: <span style=color:#e6db74>&#34;PersonalizeS3BucketAccessPolicy&#34;</span>,
    <span style=color:#f92672>&#34;Statement&#34;</span>: [
        {
            <span style=color:#f92672>&#34;Sid&#34;</span>: <span style=color:#e6db74>&#34;PersonalizeS3BucketAccessPolicy&#34;</span>,
            <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
            <span style=color:#f92672>&#34;Principal&#34;</span>: {
	            <span style=color:#f92672>&#34;Service&#34;</span>: <span style=color:#e6db74>&#34;personalize.amazonaws.com&#34;</span>
            },
            <span style=color:#f92672>&#34;Action&#34;</span>: [
                <span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
                <span style=color:#e6db74>&#34;s3:ListBucket&#34;</span>
            ],
            <span style=color:#f92672>&#34;Resource&#34;</span>: [
                <span style=color:#e6db74>&#34;arn:aws:s3:::＜バケット名＞&#34;</span>,
                <span style=color:#e6db74>&#34;arn:aws:s3:::＜バケット名＞/*&#34;</span>
            ]
        }
    ]
}
</code></pre></div><h2 id=第4章-amazon-sagemaker>第4章 Amazon SageMaker</h2><h3 id=433-トレーニングデータの準備>4.3.3 トレーニングデータの準備</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sklearn.datasets <span style=color:#f92672>import</span> load_boston
boston <span style=color:#f92672>=</span> load_boston()

<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;data:&#39;</span>, boston<span style=color:#f92672>.</span>data[<span style=color:#ae81ff>0</span>])
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;target:&#39;</span>, boston<span style=color:#f92672>.</span>target[<span style=color:#ae81ff>0</span>])
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;feature_names:&#39;</span>, boston<span style=color:#f92672>.</span>feature_names)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> pandas <span style=color:#f92672>as</span> pd
df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(boston<span style=color:#f92672>.</span>data, columns<span style=color:#f92672>=</span>boston<span style=color:#f92672>.</span>feature_names)
df[<span style=color:#e6db74>&#39;PRICE&#39;</span>] <span style=color:#f92672>=</span> boston<span style=color:#f92672>.</span>target
df<span style=color:#f92672>.</span>head()
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>%</span>matplotlib inline
<span style=color:#f92672>import</span> matplotlib.pyplot <span style=color:#f92672>as</span> plt

pd<span style=color:#f92672>.</span>plotting<span style=color:#f92672>.</span>scatter_matrix(df, figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>15</span>,<span style=color:#ae81ff>15</span>), range_padding<span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span>)
</code></pre></div><h3 id=434-トレーニングデータの加工>4.3.4 トレーニングデータの加工</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;boston.data:&#39;</span>, boston<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>dtype)
data <span style=color:#f92672>=</span> boston<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>astype(<span style=color:#e6db74>&#39;float32&#39;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;data:&#39;</span>, data<span style=color:#f92672>.</span>dtype)

<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;boston.target:&#39;</span>, boston<span style=color:#f92672>.</span>target<span style=color:#f92672>.</span>dtype)
target <span style=color:#f92672>=</span> boston<span style=color:#f92672>.</span>target<span style=color:#f92672>.</span>astype(<span style=color:#e6db74>&#39;float32&#39;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;target:&#39;</span>, target<span style=color:#f92672>.</span>dtype)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sklearn.model_selection <span style=color:#f92672>import</span> train_test_split
X_train, X_test, y_train, y_test <span style=color:#f92672>=</span> train_test_split(data, target, test_size<span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span>)
<span style=color:#66d9ef>print</span>(len(X_train), len(X_test))

X_train, X_valid, y_train, y_valid <span style=color:#f92672>=</span> train_test_split(X_train, y_train, test_size<span style=color:#f92672>=</span><span style=color:#ae81ff>0.3</span>)
<span style=color:#66d9ef>print</span>(len(X_train), len(X_valid))
</code></pre></div><h3 id=435-ハイパーパラメータの設定とs3へのデータのアップロード>4.3.5 ハイパーパラメータの設定とS3へのデータのアップロード</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> sagemaker
<span style=color:#f92672>from</span> sagemaker <span style=color:#f92672>import</span> get_execution_role

role <span style=color:#f92672>=</span> get_execution_role()
<span style=color:#66d9ef>print</span>(role)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>linear <span style=color:#f92672>=</span> sagemaker<span style=color:#f92672>.</span>LinearLearner(
    role,
    train_instance_count<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>＜インスタンス数</span> <span style=color:#960050;background-color:#1e0010>例：</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>＞</span>,
    train_instance_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜インスタンスタイプ 例：ml.m5.large＞&#39;</span>,
    output_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜モデルを保存するS3バケットとプレフィックス＞&#39;</span>,
    predictor_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;regressor&#39;</span>,
    epochs<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>＜エポック数＞</span>,
    early_stopping_patience<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>＜早期終了しないエポック数＞</span>
)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>train <span style=color:#f92672>=</span> linear<span style=color:#f92672>.</span>record_set(X_train, labels<span style=color:#f92672>=</span>y_train, channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;train&#39;</span>)
validation <span style=color:#f92672>=</span> linear<span style=color:#f92672>.</span>record_set(X_valid, labels<span style=color:#f92672>=</span>y_valid, channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;validation&#39;</span>)
test <span style=color:#f92672>=</span> linear<span style=color:#f92672>.</span>record_set(X_test, labels<span style=color:#f92672>=</span>y_test, channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;test&#39;</span>)
</code></pre></div><h4 id=column-ローカルpcのjupyter-notebookを使用する場合>COLUMN ローカルPCのJupyter Notebookを使用する場合</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#960050;background-color:#1e0010>!</span>pip install requests<span style=color:#f92672>==</span><span style=color:#ae81ff>2.20</span><span style=color:#f92672>.</span><span style=color:#ae81ff>1</span>
<span style=color:#960050;background-color:#1e0010>!</span>pip install <span style=color:#960050;background-color:#1e0010>–</span>upgrade sagemaker
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> sagemaker

role <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;＜IAMロールのARN文字列＞&#39;</span>

boto_session <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>Session(region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ap-northeast-1&#39;</span>)
sagemaker_session <span style=color:#f92672>=</span> sagemaker<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>Session(boto_session<span style=color:#f92672>=</span>boto_session)

linear <span style=color:#f92672>=</span> sagemaker<span style=color:#f92672>.</span>LinearLearner(
    role,
    train_instance_count<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>＜インスタンス数＞</span>,
    train_instance_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜インスタンスタイプ＞&#39;</span>,
    output_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜モデルを保存するS3バケットとプレフィックス＞&#39;</span>,
    predictor_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;regressor&#39;</span>,
    sagemaker_session<span style=color:#f92672>=</span>sagemaker_session
)
</code></pre></div><h3 id=436-トレーニングジョブの作成>4.3.6 トレーニングジョブの作成</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>linear<span style=color:#f92672>.</span>fit([train, validation, test], mini_batch_size<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, wait<span style=color:#f92672>=</span>True, job_name<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>’＜ジョブ名＞’</span>)
</code></pre></div><h3 id=4311-エンドポイントの動作確認>4.3.11 エンドポイントの動作確認</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sagemaker.predictor <span style=color:#f92672>import</span> csv_serializer, json_deserializer

predictor <span style=color:#f92672>=</span> sagemaker<span style=color:#f92672>.</span>predictor<span style=color:#f92672>.</span>RealTimePredictor(<span style=color:#e6db74>&#39;＜エンドポイント名＞&#39;</span>)

predictor<span style=color:#f92672>.</span>content_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;text/csv&#39;</span>
predictor<span style=color:#f92672>.</span>serializer <span style=color:#f92672>=</span> csv_serializer
predictor<span style=color:#f92672>.</span>deserializer <span style=color:#f92672>=</span> json_deserializer

<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>10</span>):
    result <span style=color:#f92672>=</span> predictor<span style=color:#f92672>.</span>predict(X_test[i])
    <span style=color:#66d9ef>print</span>(result, y_test[i])
</code></pre></div><h3 id=4313-バッチ変換ジョブ>4.3.13 バッチ変換ジョブ</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> pandas <span style=color:#f92672>as</span> pd
<span style=color:#f92672>import</span> boto3

df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(boston<span style=color:#f92672>.</span>data)
df<span style=color:#f92672>.</span>to_csv(<span style=color:#e6db74>&#39;boston_data.csv&#39;</span>, header<span style=color:#f92672>=</span>False, index<span style=color:#f92672>=</span>False)

s3 <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>resource(<span style=color:#e6db74>&#39;s3&#39;</span>)
s3<span style=color:#f92672>.</span>Bucket(<span style=color:#e6db74>&#39;＜S3バケット名&#39;</span>)<span style=color:#f92672>.</span>Object(<span style=color:#e6db74>&#39;boston_data.csv&#39;</span>)<span style=color:#f92672>.</span>upload_file(<span style=color:#e6db74>&#39;boston_data.csv&#39;</span>)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> sagemaker

transformer <span style=color:#f92672>=</span>sagemaker<span style=color:#f92672>.</span>transformer<span style=color:#f92672>.</span>Transformer(
    base_transform_job_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;BatchTransformer&#39;</span>,
    model_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜モデル名＞&#39;</span>,
    instance_count<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>＜インスタンス数</span>　<span style=color:#960050;background-color:#1e0010>例：</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>＞</span>,
    instance_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜インスタンスタイプ　例：ml.m5.large＞&#39;</span>,
    output_path<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;＜結果を出力するS3バケットとプレフィックス＞&#39;</span>
)

transformer<span style=color:#f92672>.</span>transform(<span style=color:#e6db74>&#39;＜CSVファイルをアップロードしたS3パス＞/boston_data.csv&#39;</span>,  content_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;text/csv&#39;</span>, split_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Line&#39;</span>)

<span style=color:#75715e># バッチ変換ジョブの完了を待つ場合（任意）</span>
transformer<span style=color:#f92672>.</span>wait()
</code></pre></div><h3 id=442-線形学習linearlearner>4.4.2 線形学習（LinearLearner）</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> sagemaker
<span style=color:#f92672>from</span> sagemaker <span style=color:#f92672>import</span> get_execution_role
<span style=color:#f92672>from</span> sklearn.datasets <span style=color:#f92672>import</span> load_iris
<span style=color:#f92672>from</span> sklearn.model_selection <span style=color:#f92672>import</span> train_test_split

iris <span style=color:#f92672>=</span> load_iris()
data <span style=color:#f92672>=</span> iris<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>astype(<span style=color:#e6db74>&#39;float32&#39;</span>)
target <span style=color:#f92672>=</span> iris<span style=color:#f92672>.</span>target<span style=color:#f92672>.</span>astype(<span style=color:#e6db74>&#39;float32&#39;</span>)

role <span style=color:#f92672>=</span> get_execution_role()

linear <span style=color:#f92672>=</span> sagemaker<span style=color:#f92672>.</span>LinearLearner(
    role,
    train_instance_count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
    train_instance_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ml.m5.large&#39;</span>,
    predictor_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;multiclass_classifier&#39;</span>, <span style=color:#75715e>#多値分類のためmulti_classifier</span>
    num_classes<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> <span style=color:#75715e># 3種類に分類するため3</span>
)

X_train, X_test, y_train, y_test <span style=color:#f92672>=</span> train_test_split(data, target, test_size<span style=color:#f92672>=</span><span style=color:#ae81ff>0.3</span>)
train <span style=color:#f92672>=</span> linear<span style=color:#f92672>.</span>record_set(X_train, labels<span style=color:#f92672>=</span>y_train)
test <span style=color:#f92672>=</span> linear<span style=color:#f92672>.</span>record_set(X_test, labels<span style=color:#f92672>=</span>y_test, channel<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;test&#39;</span>)

linear<span style=color:#f92672>.</span>fit([train, test], mini_batch_size<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</code></pre></div><h3 id=443-xgboost>4.4.3 XGBoost</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> boto3
<span style=color:#f92672>import</span> sagemaker
<span style=color:#f92672>from</span> sagemaker.session <span style=color:#f92672>import</span> s3_input
<span style=color:#f92672>from</span> sklearn.datasets <span style=color:#f92672>import</span> load_boston
<span style=color:#f92672>from</span> sklearn.model_selection <span style=color:#f92672>import</span> train_test_split
<span style=color:#f92672>import</span> pandas <span style=color:#f92672>as</span> pd

boto_session <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>Session(region_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ap-northeast-1&#39;</span>)

<span style=color:#75715e># データの準備</span>
boston <span style=color:#f92672>=</span> load_boston()
df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(boston<span style=color:#f92672>.</span>data, columns<span style=color:#f92672>=</span>boston<span style=color:#f92672>.</span>feature_names)
df[<span style=color:#e6db74>&#39;PRICE&#39;</span>] <span style=color:#f92672>=</span> boston<span style=color:#f92672>.</span>target
df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>iloc[:, [<span style=color:#ae81ff>13</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span>,<span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>7</span>,<span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>9</span>,<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>11</span>,<span style=color:#ae81ff>12</span>]]

<span style=color:#75715e># トレーニングデータと検証データに分割し、CSVファイルを作成</span>
train, valid <span style=color:#f92672>=</span> train_test_split(df<span style=color:#f92672>.</span>values, test_size<span style=color:#f92672>=</span><span style=color:#ae81ff>0.3</span>)
train_df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(train)
valid_df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(valid)
train_df<span style=color:#f92672>.</span>to_csv(<span style=color:#e6db74>&#39;boston_train.csv&#39;</span>, header<span style=color:#f92672>=</span>False, index<span style=color:#f92672>=</span>False)
valid_df<span style=color:#f92672>.</span>to_csv(<span style=color:#e6db74>&#39;boston_valid.csv&#39;</span>, header<span style=color:#f92672>=</span>False, index<span style=color:#f92672>=</span>False)

<span style=color:#75715e># トレーニングデータと検証データをS3にアップロード</span>
b <span style=color:#f92672>=</span> boto_session<span style=color:#f92672>.</span>resource(<span style=color:#e6db74>&#39;s3&#39;</span>)<span style=color:#f92672>.</span>Bucket(<span style=color:#e6db74>&#39;＜バケット名＞&#39;</span>)
b<span style=color:#f92672>.</span>Object(<span style=color:#e6db74>&#39;boston_train.csv&#39;</span>)<span style=color:#f92672>.</span>upload_file(<span style=color:#e6db74>&#39;boston_train.csv&#39;</span>)
b<span style=color:#f92672>.</span>Object(<span style=color:#e6db74>&#39;boston_valid.csv&#39;</span>)<span style=color:#f92672>.</span>upload_file(<span style=color:#e6db74>&#39;boston_valid.csv&#39;</span>)

train <span style=color:#f92672>=</span> s3_input(<span style=color:#e6db74>&#39;s3://＜バケット名＞/boston_train.csv&#39;</span>, content_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;text/csv&#39;</span>)
valid <span style=color:#f92672>=</span> s3_input(<span style=color:#e6db74>&#39;s3://＜バケット名＞/boston_valid.csv&#39;</span>, content_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;text/csv&#39;</span>)

<span style=color:#75715e># XGBoostインスタンスの作成</span>
container <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;501404015308.dkr.ecr.ap-northeast-1.amazonaws.com/xgboost:latest&#39;</span>
xgboost <span style=color:#f92672>=</span> sagemaker<span style=color:#f92672>.</span>estimator<span style=color:#f92672>.</span>Estimator(
    container,
    role,
    <span style=color:#ae81ff>1</span>, <span style=color:#75715e>#インスタンス数</span>
    <span style=color:#e6db74>&#39;ml.m5.large&#39;</span>, <span style=color:#75715e>#インスタンスタイプ</span>
)

<span style=color:#75715e># ハイパーパラメータの設定</span>
xgboost<span style=color:#f92672>.</span>set_hyperparameters(
    objective<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;reg:linear&#39;</span>, <span style=color:#75715e># 回帰を行うことを指定</span>
    num_round<span style=color:#f92672>=</span><span style=color:#ae81ff>25</span> <span style=color:#75715e># トレーニングを実行するラウンド数</span>
)

<span style=color:#75715e># トレーニングジョブの作成</span>
xgboost<span style=color:#f92672>.</span>fit({<span style=color:#e6db74>&#39;train&#39;</span>: train, <span style=color:#e6db74>&#39;validation&#39;</span>: valid}) <span style=color:#75715e># チャネル名をキーとした辞書型が引数</span>
</code></pre></div><h3 id=444-主成分分析pca>4.4.4 主成分分析（PCA）</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> sagemaker
<span style=color:#f92672>from</span> sagemaker <span style=color:#f92672>import</span> get_execution_role
<span style=color:#f92672>from</span> sklearn.datasets <span style=color:#f92672>import</span> load_boston

boston <span style=color:#f92672>=</span> load_boston()
data <span style=color:#f92672>=</span> boston<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>astype(<span style=color:#e6db74>&#39;float32&#39;</span>)

role <span style=color:#f92672>=</span> get_execution_role()
pca <span style=color:#f92672>=</span> sagemaker<span style=color:#f92672>.</span>PCA(
    role,
    train_instance_count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
    train_instance_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ml.m5.large&#39;</span>,
    num_components<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>,
    algorithm_mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;regular&#39;</span>
)

train <span style=color:#f92672>=</span> pca<span style=color:#f92672>.</span>record_set(data)

pca<span style=color:#f92672>.</span>fit(train, mini_batch_size<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</code></pre></div><h3 id=445-k-means>4.4.5 K-Means</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> sagemaker
<span style=color:#f92672>from</span> sklearn.datasets <span style=color:#f92672>import</span> load_iris

iris <span style=color:#f92672>=</span> load_iris()
data <span style=color:#f92672>=</span> iris<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>astype(<span style=color:#e6db74>&#39;float32&#39;</span>)

role <span style=color:#f92672>=</span> get_execution_role()
kmeans <span style=color:#f92672>=</span> sagemaker<span style=color:#f92672>.</span>KMeans(
    role,
    train_instance_count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
    train_instance_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ml.m5.large&#39;</span>,
    k<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, <span style=color:#75715e># 分類したいクラス数</span>
)

train <span style=color:#f92672>=</span> kmeans<span style=color:#f92672>.</span>record_set(data)

kmeans<span style=color:#f92672>.</span>fit(train, mini_batch_size<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</code></pre></div><h3 id=452-sagemaker-autopilot>4.5.2 SageMaker Autopilot</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sklearn.datasets <span style=color:#f92672>import</span> fetch_california_housing
<span style=color:#f92672>import</span> pandas <span style=color:#f92672>as</span> pd

housing <span style=color:#f92672>=</span> fetch_california_housing()
df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(housing<span style=color:#f92672>.</span>data, columns<span style=color:#f92672>=</span>housing<span style=color:#f92672>.</span>feature_names)
df[<span style=color:#e6db74>&#39;HouseValue&#39;</span>] <span style=color:#f92672>=</span> housing<span style=color:#f92672>.</span>target
df<span style=color:#f92672>.</span>to_csv(<span style=color:#e6db74>&#39;housing.csv&#39;</span>, index<span style=color:#f92672>=</span>False)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>df<span style=color:#f92672>.</span>head()
</code></pre></div><h2 id=第5章-aws-deep-learning-ami>第5章 AWS Deep Learning AMI</h2><h3 id=532-tensorflowとkearsによるモデル構築>5.3.2 TensorFlowとKearsによるモデル構築</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> tensorflow <span style=color:#f92672>as</span> tf
<span style=color:#f92672>import</span> keras
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> keras.datasets <span style=color:#f92672>import</span> cifar10
<span style=color:#f92672>from</span> keras.utils <span style=color:#f92672>import</span> np_utils

<span style=color:#75715e># データセットのダウンロード</span>
(X_train, y_train), (X_test, y_test) <span style=color:#f92672>=</span> cifar10<span style=color:#f92672>.</span>load_data()

<span style=color:#75715e># One-Hot形式に変換</span>
y_train <span style=color:#f92672>=</span> np_utils<span style=color:#f92672>.</span>to_categorical(y_train)
y_test <span style=color:#f92672>=</span> np_utils<span style=color:#f92672>.</span>to_categorical(y_test)

<span style=color:#75715e># 標準化</span>
X_train <span style=color:#f92672>=</span> X_train<span style=color:#f92672>.</span>astype(<span style=color:#e6db74>&#39;float32&#39;</span>)
X_test <span style=color:#f92672>=</span> X_test<span style=color:#f92672>.</span>astype(<span style=color:#e6db74>&#39;float32&#39;</span>)
X_train <span style=color:#f92672>=</span> X_train <span style=color:#f92672>/</span> <span style=color:#ae81ff>255</span>
X_test <span style=color:#f92672>=</span> X_test <span style=color:#f92672>/</span> <span style=color:#ae81ff>255</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> keras.models <span style=color:#f92672>import</span> Sequential
<span style=color:#f92672>from</span> keras.layers <span style=color:#f92672>import</span> Dense, Activation, Flatten
<span style=color:#f92672>from</span> keras.layers <span style=color:#f92672>import</span> Conv2D, MaxPooling2D

model <span style=color:#f92672>=</span> Sequential()

<span style=color:#75715e># 1回目の畳み込みとプーリング</span>
model<span style=color:#f92672>.</span>add(Conv2D(<span style=color:#ae81ff>32</span>, (<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>), padding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;same&#39;</span>, input_shape<span style=color:#f92672>=</span>X_train<span style=color:#f92672>.</span>shape[<span style=color:#ae81ff>1</span>:]))
model<span style=color:#f92672>.</span>add(Activation(<span style=color:#e6db74>&#39;relu&#39;</span>))
model<span style=color:#f92672>.</span>add(MaxPooling2D(pool_size<span style=color:#f92672>=</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>)))

<span style=color:#75715e># 2回目の畳み込みとプーリング</span>
model<span style=color:#f92672>.</span>add(Conv2D(<span style=color:#ae81ff>64</span>, (<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>)))
model<span style=color:#f92672>.</span>add(Activation(<span style=color:#e6db74>&#39;relu&#39;</span>))
model<span style=color:#f92672>.</span>add(MaxPooling2D(pool_size<span style=color:#f92672>=</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>)))

<span style=color:#75715e># 全結合層</span>
model<span style=color:#f92672>.</span>add(Flatten())
model<span style=color:#f92672>.</span>add(Dense(<span style=color:#ae81ff>512</span>))
model<span style=color:#f92672>.</span>add(Activation(<span style=color:#e6db74>&#39;relu&#39;</span>))
model<span style=color:#f92672>.</span>add(Dense(<span style=color:#ae81ff>10</span>))
model<span style=color:#f92672>.</span>add(Activation(<span style=color:#e6db74>&#39;softmax&#39;</span>))

model<span style=color:#f92672>.</span>compile(loss<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;categorical_crossentropy&#39;</span>, optimizer<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;adam&#39;</span>, metrics<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;accuracy&#39;</span>])
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>model<span style=color:#f92672>.</span>fit(X_train, y_train, batch_size<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span>, epochs<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, verbose<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>loss, accuracy <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>evaluate(X_test, y_test, verbose<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Accuracy&#39;</span>, <span style=color:#e6db74>&#39;{:.2f}&#39;</span><span style=color:#f92672>.</span>format(accuracy))
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>model<span style=color:#f92672>.</span>save(<span style=color:#e6db74>&#39;cifar10-cnn.h5&#39;</span>)
<span style=color:#960050;background-color:#1e0010>!</span>ls <span style=color:#f92672>-</span>l
</code></pre></div><h3 id=524-構築したモデルのデプロイ>5.2.4 構築したモデルのデプロイ</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> keras.models <span style=color:#f92672>import</span> load_model
<span style=color:#f92672>from</span> tensorflow.python.estimator.export <span style=color:#f92672>import</span> export

keras_model_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;cifar10-cnn.h5&#39;</span>
model <span style=color:#f92672>=</span> load_model(keras_model_path)
estimator <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>estimator<span style=color:#f92672>.</span>model_to_estimator(keras_model_path<span style=color:#f92672>=</span>keras_model_path, model_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;./&#39;</span>)

feature_spec <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;conv2d_1_input&#39;</span>: model<span style=color:#f92672>.</span>input}
serving_input_fn <span style=color:#f92672>=</span> export<span style=color:#f92672>.</span>build_raw_serving_input_receiver_fn(feature_spec)
estimator<span style=color:#f92672>.</span>_model_dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;./keras&#39;</span>
estimator<span style=color:#f92672>.</span>export_savedmodel(<span style=color:#e6db74>&#39;cifar10-cnn&#39;</span>, serving_input_fn)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> grpc
<span style=color:#f92672>import</span> tensorflow <span style=color:#f92672>as</span> tf
<span style=color:#f92672>from</span> tensorflow_serving.apis <span style=color:#f92672>import</span> predict_pb2
<span style=color:#f92672>from</span> tensorflow_serving.apis <span style=color:#f92672>import</span> prediction_service_pb2_grpc

channel <span style=color:#f92672>=</span> grpc<span style=color:#f92672>.</span>insecure_channel(<span style=color:#e6db74>&#39;localhost:9000&#39;</span>)
stub <span style=color:#f92672>=</span> prediction_service_pb2_grpc<span style=color:#f92672>.</span>PredictionServiceStub(channel)

request <span style=color:#f92672>=</span> predict_pb2<span style=color:#f92672>.</span>PredictRequest()
request<span style=color:#f92672>.</span>model_spec<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;cifar10-cnn&#39;</span>
feature <span style=color:#f92672>=</span> X_test[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>reshape(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>3</span>)
request<span style=color:#f92672>.</span>inputs[<span style=color:#e6db74>&#39;conv2d_1_input&#39;</span>]<span style=color:#f92672>.</span>CopyFrom(tf<span style=color:#f92672>.</span>contrib<span style=color:#f92672>.</span>util<span style=color:#f92672>.</span>make_tensor_proto(feature))

result <span style=color:#f92672>=</span> stub<span style=color:#f92672>.</span>Predict(request, <span style=color:#ae81ff>10.0</span>)
<span style=color:#66d9ef>print</span>(result)
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>print</span>(y_test[<span style=color:#ae81ff>0</span>])
</code></pre></div></article></section></div><footer class=footer><section class=container>©
2020 -
2021
Inoue, Ken'ichi</section></footer><script src=https://code.jquery.com/jquery-3.5.0.min.js integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/typed.js@2.0.11></script><script src=https://inoccu.com/js/main.js></script></main><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-2794204-22','auto'),ga('send','pageview'))</script></body></html>